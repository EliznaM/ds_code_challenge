---
title: "Untitled"
output: html_document
date: "2023-08-11"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.height = 16, fig.width = 20)
```

## Overview

```{r setup2}

# libraries
library(kableExtra)
library(knitr)
library(tidyverse)

# colours and theme




# functions


```



```{r data_prep}

# read file from local

dta <- read_csv("data/sr_hex_truncated.csv")

glimpse(dta)

# prepare ----------------------------------------------------------
  # make month and year columns

dta <- dta %>% 
  mutate(year_creation = lubridate::year(creation_timestamp),
         month_creation = lubridate::month(creation_timestamp),
         year_completion = lubridate::year(completion_timestamp),
         month_completion = lubridate::month(completion_timestamp))

mnths <- c("jan", "feb", "mar", "apr", "may", "jun", "jul",
           "aug", "sep", "oct", "nov", "dec")

unique(dta$month_creation)
dta$month_creation <- factor(dta$month_creation, levels = 1:12,  labels = mnths)
dta$month_completion <- factor(dta$month_completion, levels = 1:12, labels = mnths)

```

```{r data_checks}
sum(is.na(dta$notification_number))
# no missing notification nrs

length(dta$notification_number) == length(unique(dta$notification_number))
# each row is unique entry

# missingness

x <- nrow(dta)

map_dbl(dta, ~sum(is.na(.x))/x) %>% 
  sort()

dta %>% 
  group_by(is.na(directorate), is.na(department), is.na(branch), 
           is.na(section), is.na(official_suburb)) %>% 
  count()

# dates



```

### Description of the data and preparation steps

#### Missingness

We investigated missingness that would make interpretation hard.  Entries for which any of the Directorate, Department, Branch, Section or Official suburb were missing are visualised (Figure A). Entries with missing Directorate were in general also missing for the other categories. Entries for which Directorate was missing, but Official suburb was not(n = 1256), accounted for at most 4% of entries for any suburb and the suburb with the highest percentage of missing entries of this kind, was Kewtown(Figure B). 

```{r missing1}
tmp <- dta %>% 
  select(directorate, department, branch, section, official_suburb) %>% 
  mutate(across(everything(), ~as.numeric(is.na(.x)))) %>% 
  as.data.frame()

na_interpret_affected <- UpSetR::upset(tmp)

na_interpret_affected
grid::grid.text("Fig A",x = 0.65, y=0.95, gp=grid::gpar(fontsize=20))

plotdta <- dta %>% 
  group_by(official_suburb) %>% 
  count(name = "total_suburb") %>% 
  inner_join(dta %>% 
  filter(is.na(directorate) & !is.na(official_suburb)) %>% 
  group_by(official_suburb) %>% 
  count(name = "n_missing")) %>% 
  mutate(percentage_missing = n_missing/total_suburb*100) %>% 
  arrange(desc(n_missing), desc(percentage_missing)) %>% 
  ungroup() 

plotdta %>% 
  slice(1:20) %>% 
  ggplot()+
  geom_point(aes(percentage_missing, reorder(official_suburb, percentage_missing), size = n_missing))+
  labs(title = "Fig. B: Top 20 Suburbs with missing Directorate")

# missing directorate and dates

unique(dta$month_creation)

dta %>% 
  group_by(year_creation, month_creation) %>% 
  count(name = "total_ym") %>% 
  inner_join(dta %>% 
               group_by(year_creation, month_creation, is.na(directorate)) %>% 
               count(name = "n_missing")) %>%
  ungroup() %>% 
  rename(missing_directorate = 4) %>% 
  filter(missing_directorate == TRUE) %>% 
  mutate(percentage_missing = n_missing/total_ym*100) %>% 
  kable() %>%
  kable_styling(full_width = FALSE, position = "left")

```

Of the entries with Official suburb missing, ...

```{r}

plotdta <- dta %>% 
  group_by(directorate) %>% 
  count(name = "total_directorate") %>%
  inner_join(dta %>% 
               filter(is.na(official_suburb)) %>% 
               group_by(directorate) %>% 
                        count(name = "n_missing")) %>% 
  ungroup() %>% 
  mutate(percentage_missing = n_missing/total_directorate*100)

plotdta %>% 
  ggplot()+
  geom_point(aes(percentage_missing, reorder(directorate, percentage_missing), size = n_missing))+
  labs(title = "Fig. C: Missing Suburbs per Directorate")

# Exclude if missing directorate

dta <- dta %>% 
  filter(!is.na(directorate))


# Missingness in urban mobility
unique(dta$directorate)

dta_um <- dta %>% 
  filter(directorate == "URBAN MOBILITY")

x <- which(names(dta_um) %in% c("code_group", "code", "cause_code_group", "cause_code"))

map(dta_um[x], ~sort(unique(.x))) 
map(dta_um[x], ~sum(is.na(.x))) 

dta_um %>%
  select(all_of(x)) %>% 
  group_by(is.na(.)) %>% 
  count()

x <- nrow(dta_um)

x1 <- dta_um %>% 
  group_by(is.na(cause_code_group), is.na(cause_code)) %>% 
  count(name = "missing_cause") %>% 
  ungroup() %>% 
  rename(...1 = 1, ...2 = 2) %>% 
  filter(...1 == TRUE & ...2 == TRUE) %>% 
  pull(missing_cause)

tibble(msg = glue::glue("Missing cause for {round(x1/x*100, 2)}% of entries.")) %>% 
  kable(col.names = NULL) %>%
  kable_styling(full_width = FALSE, position = "left")

```


```{r overview}
x <- nrow(dta)

dta %>% 
  group_by(directorate) %>% 
  count(name = "Nr_of_entries") %>% 
  mutate(Percentage_of_total = round(Nr_of_entries/x*100, 2)) %>% 
  arrange(desc(Nr_of_entries)) %>% 
  kable(title = "Number and percentage of entries per Directorate") %>%
  kable_styling(full_width = FALSE, position = "left")

dta %>% 
  group_by(year_creation, month_creation) %>% 
  count(name = "total_ym") %>% 
  inner_join(dta %>% 
               group_by(year_creation, month_creation, directorate) %>% 
               count(name = "Nr_of_entries")) %>% 
  ungroup() %>% 
  mutate(Percentage_of_total = round(Nr_of_entries/total_ym*100, 2)) %>% 
  arrange(desc(Nr_of_entries)) %>% 
  ggplot(aes(month_creation, Percentage_of_total, 
             fill = reorder(directorate, Percentage_of_total)))+
  geom_col()+
  facet_wrap(~year_creation, scales = "free_x") # resize left bar?



```



## "In which 3 suburbs should the Urban Mobility directorate concentrate their infrastructure improvement efforts?"






## 1. Focusing on the Urban Mobility directorate - "What is the median & 80th percentile time to complete each service request across the City?" (each row represent a service request).
    
## 2. Focusing on the Urban Mobility directorate - "What is the median & 80th percentile time to complete each service request for the 3 suburbs identified in (1)?" (each row represent a service request).



## 3. "Is there any significant differences in the median and 80th percentile completion times between the City as a whole and the 3 suburbs identified in(1)?".  Please elaborate on the similarities or differences.


## 3. Provide a visual mock of a dashboard for the purpose of monitoring progress in applying the insights developed in (1) & (2). It should focus the user on performance pain points. Add a note for each visual element, explaining how it helps fulfill this overall function. Please also provide a brief explanation as to how the data provided would be used to realise what is contained in your mock.


## 4. Identify value-adding insights for the management of Urban Mobility, from the dataset provided, in regard to commuter transport within the City.
 